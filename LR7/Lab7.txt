Лабораторная работа №7
Классификация
(максимум – 11 баллов)
Основная часть (6 баллов)
В этом задании дан датасет с реальными данными одной строительной компании о бронированиях на покупку недвижимости.
Бронирование может привести к заключению договора на покупку, а может быть отменено. Для планирования своих финансовых показателей компания хочет прогнозировать, приведет ли бронирование к заключению договора или нет.
Таким образом, вам предстоит построить модель для бинарной классификации бронирований.
В этом задании будем работать только с жилой недвижимостью, поскольку именно по ней имеется больше всего данных.
1.	Загрузите данные из файла "база.csv". Столбцы (признаки) имеют следующий смысл:
a.	УИД_Брони – уникальный идентификатор брони (для классификации его использовать не надо – это просто id)
b.	ДатаБрони – дата установления брони
c.	ВремяБрони – время установления брони (GMT+4)
d.	ИсточникБрони – способ оформления брони: МП — мобильное приложение, ручная — офис продаж (бинарный признак)
e.	ВременнаяБронь – подтвержденная заявка на бронь(«Нет») или заявка на бронь не подтверждена отделом продаж («Да») (бинарный признак)
f.	СледующийСтатус – если пусто или «В резерве» — статус еще не определен, «Продана» — договор оформлен, «Свободна» — бронь снята (отменена). Это и есть целевой признак, который нужно научиться предсказывать
g.	Город – город проекта
h.	ВидПомещения – один из 4 видов: жилые помещения, нежилые помещения, кладовые, паркинг. Нас будут интересовать бронирования только со значением этого признака «жилые помещения».
i.	Тип – количество комнат для жилых помещений (для остальных видов неактуально)
j.	ПродаваемаяПлощадь – общая продаваемая площадь помещения
k.	Этаж – этаж расположения помещения
l.	СтоимостьНаДатуБрони – актуальная стоимость по прайсу на дату установления брони
m.	ТипСтоимости – «Стоимость при 100% оплате» или «Стоимость в рассрочку», остальные варианты можно считать отсутствием значения (бинарный признак)
n.	ВариантОплаты – «Единовременная оплата» или «Оплата в рассрочку» (бинарный признак)
o.	ВариантОплатыДоп – уточненный вариант оплаты: Ипотека/Вторичное жилье, если "пусто" — использовать ВариантОплаты
p.	СкидкаНаКвартиру – размер предоставленной скидки при её наличии, отрицательное значение — это наценка на помещение (как правило, при выводе из закрытого ассортимента)
q.	ФактическаяСтоимостьПомещения – стоимость заключения сделки (стоимость на дату брони за вычетом скидки)
r.	СделкаАН – участие в сделке агентства недвижимости (да/нет) (бинарный признак)
s.	ИнвестиционныйПродукт – да/нет — признак продажи помещения по инвестиционному договору (бинарный признак)
t.	Привилегия – да/нет — признак продажи помещения по инвестиционному договору типа Привилегия (бинарный признак)
u.	Статус лида (из CRM) – Статус клиента: S - успешный, P - в работе, F - забракованный
2.	Предварительная фильтрация.
a.	Поскольку нас интересуют только сделки с жилой недвижимостью, отфильтруйте данные, оставив только те, для которых «ВидПомещения» = «жилые помещения». В дальнейшем этот столбец использоваться не будет, его можно удалить (или удалите его из датасета вообще, или просто нигде далее не рассматривайте).
b.	Также для нас бесполезны данные, по которым статус не определен. Отфильтруйте данные по признаку «СледующийСтатус». В оставшихся строчках замените значение «Продана» на 1, «Свободна» – на 0.
c.	Не забывайте, что столбец «УИД_Брони» для нас также не представляет интереса – удалите его из датасета вообще, или просто нигде далее не рассматривайте.
3.	Проверьте тип данных и преобразуйте все данные к числовому типу.
a.	Для тех полей, которые по смыслу являются числовыми (например, «ПродаваемаяПлощадь») – просто проверьте правильность типа.
b.	Для бинарных признаков (например, «ИсточникБрони») выполните кодирование (один вариант закодируйте 0, другой 1).
c.	Для категориальных не бинарных признаков (например, «Город») выполните one-hot кодирование.
d.	Обратите внимание на поле «Тип». По смыслу оно числовое (количество комнат), но напрямую сконвертировать его в числовой тип мешает буковка «к» в конце. Напишите вручную преобразование, которое удаляет букву «к» в конце и конвертирует то, что осталось, в число. Если это невозможно (среди данных вам встретится еще вариант, когда в этом поле записано просто «с») – просто пока оставьте поле пустым (NaN).
4.	Проверьте, есть ли по каким-либо признакам отсутствующие данные.
a.	Отсутствующие данные в поле «СкидкаНаКвартиру» замените на 0 (это значение по умолчанию – если поле не заполнено, то скидки, по всей видимости, нет).
b.	Отсутствующие данные в полях «Тип» и «ПродаваемаяПлощадь» замените на медианное значение, вычисленное по всему набору данных (признаки кажутся достаточно важными, поэтому удалять эти столбцы не хочется; пустых значений довольно много, поэтому удалять строки тоже не очень хорошо; какого-то значения «по умолчанию» для этих полей нет; поэтому заменить эти значения на медиану представляется наилучшим решением).
c.	Что делать с полем «ВариантОплатыДоп» решите самостоятельно (можно, как указано в описании, вместо пустых значений использовать значение из поля «ВариантОплаты», но в таком случае обратите внимание, что признак становится не бинарным; допустимо также совсем убрать этот столбец из рассмотрения).
d.	По всем остальным полям примите решение самостоятельно. Если отсутствующих данных не много, то удалите соответствующие строки.
5.	Дополнение данных.
a.	Добавьте новый признак «Цена за квадратный метр». Он должен вычисляться на основе значений признаков «ФактическаяСтоимостьПомещения» и «ПродаваемаяПлощадь».
b.	Добавьте новый признак «Скидка в процентах», на основе значений «ФактическаяСтоимостьПомещения» и «СкидкаНаКвартиру».
Комментарий. Многие алгоритмы классификации, по сути, учитывают только линейную зависимость. Поэтому, несмотря на то что добавляемые признаки полностью определяются значениями других признаков, их добавление имеет смысл – их зависимость от других признаков не линейная.
6.	Выполните нормализацию. Можете самостоятельно выбрать способ нормализации. «По умолчанию» предлагается выполнить минимаксную нормализацию и привести все значения к диапазону [0;1], кроме признака «СкидкаНаКвартиру» - его логичнее приводить к диапазону [-0,5; 0,5].
7.	Проверьте датасет на сбалансированность (количество строк со значением целевого признака 0 и со значением 1). Является ли датасет сбалансированным?
8.	Сформируйте список факторных признаков и целевой признак.
9.	Выполните разбиение датасета на обучающую и тестовую выборки. При формировании обучающей и тестовой выборок строки из исходного датафрейма должны выбираться в случайном порядке. 
10.	Из библиотеки sklearn.neighbors возьмите алгоритм классификации KNN (KNeighborsClassifier). Постройте (обучите) модель. Для параметров используйте значения по умолчанию.
11.	Из библиотеки sklearn.tree возьмите алгоритм классификации на основе деревьев решений (DecisionTreeClassifier). Постройте (обучите) модель. Для параметров используйте значения по умолчанию.
12.	Получите векторы прогнозных значений целевой переменной на обучающей и на тестовой выборках для каждой из моделей.
13.	Посчитайте показатели качества: «F-мера», точность (Precision) и полнота (Recall) на обучающей и на тестовой выборках для каждой из моделей.
14.	Сделайте вывод о том, насколько хорошо удалось решить задачу прогнозирования. Какая модель оказалась лучше? Дайте интерпретацию полученных значений Precision и Recall.
Дополнительные задания (5 баллов)
15.	(1 балл) Постройте boxplot («ящик с усами») для всех числовых признаков. Отфильтруйте исходные данные, удалив выбросы. Пересоздайте тестовую и обучающую выборки, переобучите модели. Посчитайте показатели качества. Как они изменились?
16.	(2 балла) Выполните подбор параметров для алгоритмов KNN и деревьев решений. Для KNN попробуйте изменять параметр k – количество соседей, для деревьев решений – глубину дерева. Постройте графики зависимости показателей качества от значения параметра (от k в случае KNN и от глубины дерева в случае деревьев решений). Для параметра k рассматривайте диапазон от 1 до 40. Для глубины дерева – от 2 до 40. По графикам определите оптимальные значения параметров.
17.	(1 балл) Из библиотеки sklearn.linear_model возьмите алгоритм логистической регрессии (LogisticRegression). Постройте (обучите) модель. Посчитайте показатели качества. Сравните результат с другими моделями.
18.	(1 балл) Из библиотеки sklearn.svm возьмите алгоритм SVM (машины опорных векторов) (LinearSVC). Постройте (обучите) модель. Посчитайте показатели качества. Сравните результат с другими моделями.